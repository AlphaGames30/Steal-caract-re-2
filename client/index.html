<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Steal-a-Thing Babylon.js</title>
<style>
  html, body { width:100%; height:100%; margin:0; overflow:hidden; }
  #money, #message {
    position:absolute; color:yellow; font-size:24px; font-weight:bold; z-index:10;
  }
  #money { bottom:20px; right:20px; }
  #message { top:20px; left:50%; transform:translateX(-50%); color:red; display:none; }
</style>
</head>
<body>
<div id="money">ðŸ’µ 100</div>
<div id="message">Plus de place, vends-en un !</div>
<canvas id="renderCanvas"></canvas>

<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
<script>
const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas, true);

const scene = new BABYLON.Scene(engine);
scene.clearColor = new BABYLON.Color3(0.6,0.6,0.6);

// --- CamÃ©ra ---
const camera = new BABYLON.ArcRotateCamera("camera", -Math.PI/2, Math.PI/3, 50, new BABYLON.Vector3(0,0,0), scene);
camera.attachControl(canvas,true);

// --- LumiÃ¨res ---
new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,1,0), scene);

// --- Sol ---
const sol = BABYLON.MeshBuilder.CreateGround("ground",{width:90, height:100},scene);
sol.material = new BABYLON.StandardMaterial("groundMat",scene);
sol.material.diffuseColor = new BABYLON.Color3(0,0.6,0); // vert herbe

// --- Bases ---
const bases = [];
const baseWidth = 10;
const baseHeight = 10;
const baseSlots = 3;

for(let i=0;i<8;i++){
    const base = BABYLON.MeshBuilder.CreateBox("base"+i,{width:baseWidth, depth:baseHeight, height:1},scene);
    base.position.y = 0.5;
    base.position.x = (i<4 ? -30 : 30); // gauche ou droite
    base.position.z = (i%4)*25 - 37.5;
    const mat = new BABYLON.StandardMaterial("mat"+i,scene);
    mat.diffuseColor = new BABYLON.Color3(0.5,0.5,0.5);
    base.material = mat;
    base.slots = Array(baseSlots).fill(null); // slots vides
    bases.push(base);
}

// --- Joueur ---
const player = BABYLON.MeshBuilder.CreateBox("player",{width:1,height:2,depth:1},scene);
player.position.y=1;
player.position.z=40;
player.position.x=0;
const playerMaterial = new BABYLON.StandardMaterial("playerMat",scene);
playerMaterial.diffuseColor = new BABYLON.Color3(0,0,1);
player.material = playerMaterial;

// --- Argent ---
let money = 100;
const moneyDiv = document.getElementById("money");
function updateMoney(){ moneyDiv.textContent = `ðŸ’µ ${Math.floor(money)}`; }
updateMoney();

// --- Message ---
const messageDiv = document.getElementById("message");
function showMessage(text){
    messageDiv.textContent = text;
    messageDiv.style.display="block";
    setTimeout(()=>{messageDiv.style.display="none";},1500);
}

// --- PNJ ---
class PNJ{
    constructor(data,x,z){
        this.data = data;
        const size = data.name=="Petit Dragon"?2:1; // exemple forme selon nom
        this.mesh = BABYLON.MeshBuilder.CreateBox(data.name,{width:size,height:size*2,depth:size},scene);
        this.mesh.position.set(x, size, z);

        const mat = new BABYLON.StandardMaterial(data.name+"Mat",scene);
        mat.diffuseColor = PNJ.getColor(data.rarity);
        this.mesh.material = mat;

        // GUI pour nom, prix, raretÃ©
        const advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");
        const label = new BABYLON.GUI.Rectangle();
        label.width = "100px";
        label.height = "40px";
        label.background = "transparent";
        label.cornerRadius = 5;
        const textBlock = new BABYLON.GUI.TextBlock();
        textBlock.text = `${data.name} | ${data.rarity} | ${data.price}ðŸ’µ`;
        textBlock.color = "white";
        textBlock.fontSize = 14;
        label.addControl(textBlock);
        advancedTexture.addControl(label);
        label.linkWithMesh(this.mesh);
        label.linkOffsetY = -50;

        this.mesh.actionManager = new BABYLON.ActionManager(scene);
        this.mesh.actionManager.registerAction(
            new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickTrigger,()=>{
                buyPNJ(this);
            })
        );
    }

    static getColor(rarity){
        switch(rarity){
            case "Commun": return new BABYLON.Color3(0.7,0.7,0.7);
            case "Rare": return new BABYLON.Color3(0,1,0);
            case "Epic": return new BABYLON.Color3(0,0,1);
            case "LÃ©gendaire": return new BABYLON.Color3(1,0.84,0);
            default: return new BABYLON.Color3(1,1,1);
        }
    }
}

// --- PNJ disponibles ---
const availablePNJ = [
    {name:"Petit Titan", rarity:"Commun", price:50},
    {name:"Souris Malicieuse", rarity:"Commun", price:80},
    {name:"Grand HÃ©ron", rarity:"Rare", price:120},
    {name:"Petit Dragon", rarity:"Epic", price:500}
];

// --- Liste PNJ sur tapis ---
const pnjList = [];

// --- Acheter ---
function buyPNJ(pnj){
    if(money >= pnj.data.price){
        const base = bases.find(b=>b.slots.includes(null));
        if(!base){
            showMessage("Plus de place, vends-en un !");
            return;
        }
        money -= pnj.data.price;
        updateMoney();
        const index = base.slots.indexOf(null);
        base.slots[index] = pnj;
        // dÃ©placer le PNJ sur la base
        pnj.mesh.position.x = base.position.x;
        pnj.mesh.position.z = base.position.z + (index-1)*3;
    } else showMessage("Pas assez d'argent !");
}

// --- Spawn automatique toutes les 1.5s ---
setInterval(()=>{
    const data = availablePNJ[Math.floor(Math.random()*availablePNJ.length)];
    const pnj = new PNJ(data,0,-40);
    pnjList.push(pnj);
},1500);

// --- DÃ©placement PNJ vers portail ---
scene.onBeforeRenderObservable.add(()=>{
    for(let i=pnjList.length-1;i>=0;i--){
        const p = pnjList[i];
        if(!bases.some(b=>b.slots.includes(p))){
            p.mesh.position.z += 0.2;
            if(p.mesh.position.z > 50){ 
                p.mesh.dispose();
                pnjList.splice(i,1);
            }
        }
    }
});

// --- ContrÃ´les joueur ---
const inputMap = {};
scene.actionManager = new BABYLON.ActionManager(scene);
scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyDownTrigger,(evt)=>{ inputMap[evt.sourceEvent.key]=true; }));
scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyUpTrigger,(evt)=>{ inputMap[evt.sourceEvent.key]=false; }));

scene.onBeforeRenderObservable.add(()=>{
    if(inputMap["w"]) player.position.z -= 0.3;
    if(inputMap["s"]) player.position.z += 0.3;
    if(inputMap["a"]) player.position.x -= 0.3;
    if(inputMap["d"]) player.position.x += 0.3;
});

engine.runRenderLoop(()=>scene.render());
window.addEventListener("resize",()=>engine.resize());
</script>
</body>
</html>
