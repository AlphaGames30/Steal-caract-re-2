<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Steal-a-Thing 3D Bases & PNJ</title>
<style>
html, body { width:100%; height:100%; margin:0; overflow:hidden; }
#money, #message { position:absolute; font-size:16px; font-weight:bold; z-index:10; }
#money { bottom:10px; right:10px; color:yellow; }
#message { top:10px; left:50%; transform:translateX(-50%); color:red; display:none; }
</style>
</head>
<body>
<div id="money">üíµ 100</div>
<div id="message">Plus de place, vends-en un !</div>
<canvas id="renderCanvas"></canvas>

<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
<script>
const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas, true);
const scene = new BABYLON.Scene(engine);
scene.clearColor = new BABYLON.Color3(0.6,0.6,0.6);

// --- Cam√©ra ---
const camera = new BABYLON.ArcRotateCamera("cam", -Math.PI/2, Math.PI/3, 120, new BABYLON.Vector3(0,0,0), scene);
camera.attachControl(canvas,true);

// --- Lumi√®re ---
new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,1,0), scene);

// --- Sol ---
const ground = BABYLON.MeshBuilder.CreateGround("ground",{width:90,height:100},scene);
const groundMat = new BABYLON.StandardMaterial("groundMat",scene);
groundMat.diffuseColor = new BABYLON.Color3(0,0.6,0);
ground.material = groundMat;

// --- Barri√®res ---
function createWall(x,z,width,height,depth){
  const wall = BABYLON.MeshBuilder.CreateBox("wall",{width:width,height:height,depth:depth},scene);
  wall.position.set(x,height/2,z);
  const mat = new BABYLON.StandardMaterial("wallMat",scene);
  mat.diffuseColor = new BABYLON.Color3(0.5,0.5,0.5);
  wall.material = mat;
  return wall;
}
createWall(0,-50,90,10,1); // nord
createWall(0,50,90,10,1);  // sud
createWall(-45,0,1,10,100); // ouest
createWall(45,0,1,10,100);  // est

// --- Bases ---
const bases = [];
function createBase(x,z){
  const base = BABYLON.MeshBuilder.CreateBox("base",{width:10,height:5,depth:10},scene);
  base.position.set(x,2.5,z);
  const mat = new BABYLON.StandardMaterial("baseMat",scene);
  mat.diffuseColor = new BABYLON.Color3(0.7,0.7,0.7);
  base.material = mat;
  base.slots = [null,null,null]; // 3 slots par base
  bases.push(base);
  return base;
}
for(let i=0;i<4;i++) createBase(-30,i*25-37.5);
for(let i=0;i<4;i++) createBase(30,i*25-37.5);

// --- Joueur ---
const player = BABYLON.MeshBuilder.CreateBox("player",{width:1,height:2,depth:1},scene);
player.position.set(0,1,40);
player.material = new BABYLON.StandardMaterial("playerMat",scene);
player.material.diffuseColor = new BABYLON.Color3(0,0,1);

// --- Argent ---
let money = 100;
const moneyDiv = document.getElementById("money");
function updateMoney(){ moneyDiv.textContent = `üíµ ${Math.floor(money)}`; }
updateMoney();

// --- Message ---
const messageDiv = document.getElementById("message");
function showMessage(text){
  messageDiv.textContent = text;
  messageDiv.style.display="block";
  setTimeout(()=>{messageDiv.style.display="none";},1500);
}

// --- Classe PNJ ---
class PNJ{
  constructor(data,x,z){
    this.data = data;
    const size = data.name==="Petit Dragon"?1.5:1; // exemple perso personnalis√©
    this.mesh = BABYLON.MeshBuilder.CreateBox(data.name,{width:size,height:size*2,depth:size},scene);
    this.mesh.position.set(x,size,z);
    const mat = new BABYLON.StandardMaterial(data.name+"Mat",scene);
    mat.diffuseColor = PNJ.getColor(data.rarity);
    this.mesh.material = mat;

    // GUI label
    const advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");
    const label = new BABYLON.GUI.Rectangle();
    label.width="100px"; label.height="60px"; label.background="transparent";
    const textBlock = new BABYLON.GUI.TextBlock();
    textBlock.text = `${data.name}\n${data.rarity}\n${data.gain}/s\n${data.price}üíµ`;
    textBlock.color="white"; textBlock.fontSize=12; textBlock.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
    label.addControl(textBlock);
    advancedTexture.addControl(label);
    label.linkWithMesh(this.mesh);
    label.linkOffsetY=-40;

    this.mesh.actionManager = new BABYLON.ActionManager(scene);
    this.mesh.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickTrigger,()=>{
      buyPNJ(this);
    }));
  }

  static getColor(rarity){
    switch(rarity){
      case "Commun": return new BABYLON.Color3(0.7,0.7,0.7);
      case "Rare": return new BABYLON.Color3(0,1,0);
      case "Epic": return new BABYLON.Color3(0,0,1);
      case "L√©gendaire": return new BABYLON.Color3(1,0.84,0);
      default: return new BABYLON.Color3(1,1,1);
    }
  }
}

// --- PNJ disponibles ---
const availablePNJ = [
  {name:"Petit Titan", rarity:"Commun", price:50, gain:5},
  {name:"Souris Malicieuse", rarity:"Commun", price:80, gain:10},
  {name:"Grand H√©ron", rarity:"Rare", price:120, gain:25},
  {name:"Petit Dragon", rarity:"Epic", price:500, gain:50}
];

const pnjList=[];

// --- Acheter ---
function buyPNJ(pnj){
  if(money>=pnj.data.price){
    const base = bases.find(b=>b.slots.includes(null));
    if(!base){ showMessage("Plus de place, vends-en un !"); return; }
    money -= pnj.data.price;
    updateMoney();
    const index = base.slots.indexOf(null);
    base.slots[index]=pnj;
    pnj.mesh.position.x = base.position.x;
    pnj.mesh.position.z = base.position.z + (index-1)*3;
  } else showMessage("Pas assez d'argent !");
}

// --- Spawn automatique toutes les 3s ---
setInterval(()=>{
  const data = availablePNJ[Math.floor(Math.random()*availablePNJ.length)];
  const pnj = new PNJ(data,0,-40);
  pnjList.push(pnj);
},3000);

// --- D√©placement PNJ vers portail ---
scene.onBeforeRenderObservable.add(()=>{
  for(let i=pnjList.length-1;i>=0;i--){
    const p = pnjList[i];
    if(!bases.some(b=>b.slots.includes(p))){
      p.mesh.position.z += 0.2;
      if(p.mesh.position.z>50){ p.mesh.dispose(); pnjList.splice(i,1); }
    }
  }
});

// --- D√©placement joueur ---
const inputMap={};
scene.actionManager = new BABYLON.ActionManager(scene);
scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyDownTrigger,(evt)=>{inputMap[evt.sourceEvent.key]=true;}));
scene.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnKeyUpTrigger,(evt)=>{inputMap[evt.sourceEvent.key]=false;}));

scene.onBeforeRenderObservable.add(()=>{
  if(inputMap["w"]) player.position.z -= 0.3;
  if(inputMap["s"]) player.position.z += 0.3;
  if(inputMap["a"]) player.position.x -= 0.3;
  if(inputMap["d"]) player.position.x += 0.3;
});

engine.runRenderLoop(()=>scene.render());
window.addEventListener("resize",()=>engine.resize());
</script>
</body>
</html>


