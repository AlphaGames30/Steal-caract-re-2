<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Steal-a-Thing 3D Jouable</title>
<style>
  body { margin: 0; overflow: hidden; }
  #message {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    color: red;
    font-size: 24px;
    font-weight: bold;
    display: none;
    z-index: 10;
  }
  #money {
    position: absolute;
    bottom: 20px;
    right: 20px;
    color: yellow;
    font-size: 24px;
    font-weight: bold;
    z-index: 10;
  }
</style>
</head>
<body>
<div id="message">Plus de place, vends-en un !</div>
<div id="money">ðŸ’µ 100</div>

<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
<script>
const canvas = document.createElement('canvas');
canvas.id = 'renderCanvas';
canvas.style.width = '100%';
canvas.style.height = '100%';
document.body.appendChild(canvas);

const engine = new BABYLON.Engine(canvas, true);
const scene = new BABYLON.Scene(engine);

// --- CamÃ©ra ---
const camera = new BABYLON.ArcRotateCamera("camera", -Math.PI/2, Math.PI/3, 50, new BABYLON.Vector3(0,0,0), scene);
camera.attachControl(canvas, true);

// --- LumiÃ¨res ---
const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,1,0), scene);
light.intensity = 0.9;

// --- Sol ---
const ground = BABYLON.MeshBuilder.CreateGround("ground", {width:90, height:110}, scene);
const groundMat = new BABYLON.StandardMaterial("groundMat", scene);
groundMat.diffuseColor = new BABYLON.Color3(0.13,0.55,0.13); // vert herbe
ground.material = groundMat;

// --- Murs ---
const wallMat = new BABYLON.StandardMaterial("wallMat", scene);
wallMat.diffuseColor = new BABYLON.Color3(0.5,0.5,0.5);
const wallHeight = 5;
const wallThickness = 0.5;
const walls = [
  BABYLON.MeshBuilder.CreateBox("wallN",{width:90, height:wallHeight, depth:wallThickness},scene),
  BABYLON.MeshBuilder.CreateBox("wallS",{width:90, height:wallHeight, depth:wallThickness},scene),
  BABYLON.MeshBuilder.CreateBox("wallE",{width:wallThickness, height:wallHeight, depth:110},scene),
  BABYLON.MeshBuilder.CreateBox("wallW",{width:wallThickness, height:wallHeight, depth:110},scene),
];
walls[0].position.set(0, wallHeight/2, -60);
walls[1].position.set(0, wallHeight/2, 60);
walls[2].position.set(10, wallHeight/2, 0);
walls[3].position.set(-10, wallHeight/2, 0);
walls.forEach(w => { w.material = wallMat; w.checkCollisions = true; });

// --- Tapis central ---
const tapis = BABYLON.MeshBuilder.CreateGround("tapis",{width:10, height:100},scene);
tapis.position.y = 0.01;
const tapisMat = new BABYLON.StandardMaterial("tapisMat", scene);
tapisMat.diffuseColor = new BABYLON.Color3(0.49,1,0); // vert clair
tapis.material = tapisMat;

// --- Bases dÃ©corÃ©es ---
const bases = [];
for(let i=0;i<8;i++){
  const base = BABYLON.MeshBuilder.CreateBox("base"+i,{width:3,height:2,length:3},scene);
  base.position.y = 1;
  base.position.x = (i<4?-7:7); // gauche/droite
  base.position.z = (i%4)*25 - 37; // espacement
  const baseMat = new BABYLON.StandardMaterial("baseMat"+i,scene);
  baseMat.diffuseColor = new BABYLON.Color3(0.7,0.3,0.2);
  base.material = baseMat;
  bases.push(base);
}

// --- Joueur ---
const player = BABYLON.MeshBuilder.CreateBox("player",{width:1,height:2,length:1},scene);
player.position.set(0,1,50);
player.material = new BABYLON.StandardMaterial("playerMat",scene);
player.material.diffuseColor = new BABYLON.Color3(0,0,1);

// --- Argent et message ---
let money = 100;
const moneyDiv = document.getElementById('money');
function updateMoneyDisplay(){ moneyDiv.textContent=`ðŸ’µ ${Math.floor(money)}`; }
updateMoneyDisplay();
const messageDiv = document.getElementById('message');
function showMessage(text){ messageDiv.textContent=text; messageDiv.style.display='block'; setTimeout(()=>{messageDiv.style.display='none';},1500); }

// --- PNJ classe ---
class PNJ{
  constructor(name,rarity,price,x,z){
    this.name=name;
    this.rarity=rarity;
    this.price=price;
    this.mesh=BABYLON.MeshBuilder.CreateBox(name,{width:1,height:2,length:1},scene);
    this.mesh.position.set(x,1,z);
    this.mesh.material=new BABYLON.StandardMaterial("mat",scene);
    this.mesh.material.diffuseColor = PNJ.getColor(rarity);
    // Label
    const plane = BABYLON.MeshBuilder.CreatePlane(name+"label",{width:3,height:1},scene);
    plane.parent = this.mesh;
    plane.position.y=2.5;
    const advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateForMesh(plane);
    const label = new BABYLON.GUI.TextBlock();
    label.text = `${name}\n${rarity} | ${price}ðŸ’µ`;
    label.color="white";
    label.fontSize=50;
    label.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
    label.textVerticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_CENTER;
    advancedTexture.addControl(label);
    this.label = plane;
  }

  move(speed){ this.mesh.position.z += speed; }

  static getColor(rarity){
    switch(rarity){
      case "Commun": return new BABYLON.Color3(0.7,0.7,0.7);
      case "Rare": return new BABYLON.Color3(0,1,0);
      case "Epic": return new BABYLON.Color3(0,0,1);
      case "LÃ©gendaire": return new BABYLON.Color3(1,0.84,0);
      default: return new BABYLON.Color3(1,1,1);
    }
  }
}

// --- PNJ disponibles ---
const availablePNJ = [
  {name:'Petit Titan', rarity:'Commun', price:50},
  {name:'Souris Malicieuse', rarity:'Commun', price:80},
  {name:'Grand HÃ©ron', rarity:'Rare', price:120},
  {name:'Petit Dragon', rarity:'Epic', price:500},
];

const pnjList=[];

// --- Spawn automatique toutes les 1,5s ---
setInterval(()=>{
  // DÃ©termination du PNJ selon chance (simplifiÃ©e ici)
  const pnjData = availablePNJ[Math.floor(Math.random()*availablePNJ.length)];
  const pnj = new PNJ(pnjData.name,pnjData.rarity,pnjData.price,0,-50);
  pnjList.push(pnj);
},1500);

// --- ContrÃ´les joueur ---
const keys = {};
document.addEventListener('keydown',e=>keys[e.key.toLowerCase()]=true);
document.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);
const speed = 0.5;

// --- Animation ---
engine.runRenderLoop(()=>{
  // Mouvement joueur
  if(keys['w']) player.position.z -= speed;
  if(keys['s']) player.position.z += speed;
  if(keys['a']) player.position.x -= speed;
  if(keys['d']) player.position.x += speed;

  // CamÃ©ra derriÃ¨re joueur
  camera.setTarget(player.position);

  // --- DÃ©finition des bases avec slots ---
const baseSlots = 3; // chaque base peut contenir 3 PNJ max
const basePNJs = bases.map(() => []); // tableau de tableau : chaque base = tableau de PNJ

// --- Fonction pour trouver une base avec slot libre ---
function findAvailableBase() {
    for(let i=0;i<basePNJs.length;i++){
        if(basePNJs[i].length < baseSlots) return i;
    }
    return -1; // pas de base dispo
}

// --- Fonction pour acheter un PNJ ---
function buyPNJ(pnj) {
    if(money >= pnj.price){
        const baseIndex = findAvailableBase();
        if(baseIndex === -1){
            showMessage("Plus de place, vends-en un !");
            return;
        }
        // DÃ©bit argent
        money -= pnj.price;
        updateMoneyDisplay();

        // Placement PNJ dans la base
        const base = bases[baseIndex];
        const xOffset = (basePNJs[baseIndex].length - (baseSlots-1)/2) * 1.5; // Ã©cart entre PNJ
        pnj.mesh.position.set(base.position.x + xOffset, 1, base.position.z);
        pnj.label.position.set(base.position.x + xOffset, 2.5, base.position.z);

        basePNJs[baseIndex].push(pnj);

        // Retirer de la liste de spawn
        const idx = pnjList.indexOf(pnj);
        if(idx !== -1) pnjList.splice(idx,1);

    } else {
        showMessage("Pas assez d'argent !");
    }
}

// --- Raycast pour cliquer sur PNJ ---
scene.onPointerObservable.add((pointerInfo) => {
    if(pointerInfo.type === BABYLON.PointerEventTypes.POINTERDOWN){
        const pick = scene.pick(pointerInfo.event.clientX, pointerInfo.event.clientY);
        if(pick.hit && pnjList.includes(pick.pickedMesh._pnjRef)){
            buyPNJ(pick.pickedMesh._pnjRef);
        }
    }
});

// --- Lors de la crÃ©ation d'un PNJ, on lie la rÃ©fÃ©rence pour le raycast ---
class PNJ{
    constructor(name,rarity,price,x,z){
        this.name=name;
        this.rarity=rarity;
        this.price=price;
        this.mesh=BABYLON.MeshBuilder.CreateBox(name,{width:1,height:2,length:1},scene);
        this.mesh.position.set(x,1,z);
        this.mesh.material=new BABYLON.StandardMaterial("mat",scene);
        this.mesh.material.diffuseColor = PNJ.getColor(rarity);

        // Lier pour clic
        this.mesh._pnjRef = this;

        // Label
        const plane = BABYLON.MeshBuilder.CreatePlane(name+"label",{width:3,height:1},scene);
        plane.parent = this.mesh;
        plane.position.y=2.5;
        const advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateForMesh(plane);
        const label = new BABYLON.GUI.TextBlock();
        label.text = `${name}\n${rarity} | ${price}ðŸ’µ`;
        label.color="white";
        label.fontSize=50;
        label.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER;
        label.textVerticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_CENTER;
        advancedTexture.addControl(label);
        this.label = plane;
    }
    move(speed){ this.mesh.position.z += speed; }
    static getColor(rarity){
        switch(rarity){
            case "Commun": return new BABYLON.Color3(0.7,0.7,0.7);
            case "Rare": return new BABYLON.Color3(0,1,0);
            case "Epic": return new BABYLON.Color3(0,0,1);
            case "LÃ©gendaire": return new BABYLON.Color3(1,0.84,0);
            default: return new BABYLON.Color3(1,1,1);
        }
    }
}

// --- Spawn automatique toutes les 1,5s ---
setInterval(()=>{
    const pnjData = availablePNJ[Math.floor(Math.random()*availablePNJ.length)];
    const pnj = new PNJ(pnjData.name,pnjData.rarity,pnjData.price,0,-50);
    pnjList.push(pnj);
},1500);

  // DÃ©placement PNJ
  for(let i=pnjList.length-1;i>=0;i--){
    const p=pnjList[i];
    p.move(0.1);
    if(p.mesh.position.z>60){
      p.mesh.dispose();
      p.label.dispose();
      pnjList.splice(i,1);
    }
  }

  scene.render();
});

window.addEventListener('resize',()=>{ engine.resize(); });
</script>
</body>
</html>
